<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chamada Online - Aluno</title>
  <link rel="stylesheet" href="styleA.css">
<div class="container">
  <img src="logos/A3.gif" alt="Decoração esquerda" class="side-img">
</div>
<div class="card">
    <h2>Registro de Presença</h2>
    <div class="input-group">
      <input id="nome" type="text" placeholder="Seu nome">
      <input id="matricula" type="text" placeholder="Matrícula">
    </div>
    <button id="btn-presenca" onclick="registrarPresenca()">Enviar Presença</button>
    <div id="saida"></div>
     
    <!-- Mensagem de confirmação -->
<div id="confirmacao" class="confirma">
  <img src="logos/A1.png" alt="Presença confirmada" class="side-img">
  <p id="mensagem-confirmacao" class="mconfirma"></p>
</div>
  </div>

  <img src="logos/A2(A).gif" alt="Decoração direita" class="side-img right">

<script>
  const baseURL = "https://chamada-online.onrender.com/";

async function registrarPresenca() {
  const nome = document.getElementById("nome").value.trim();
  const matricula = document.getElementById("matricula").value.trim();
  const botao = document.getElementById("btn-presenca");

  if (!nome || !matricula) {
    alert("Preencha todos os campos!");
    return;
  }

  botao.disabled = true;
  botao.style.backgroundColor = "#aaa";
  botao.innerText = "Enviando...";
  setTimeout(() => {
      botao.disabled = false;
      botao.style.backgroundColor = "#4CAF50";
      botao.innerText = "Enviar Presença";
    }, 3000); // espera 3 segundos antes de reativar

  // tenta obter localização obrigatoriamente
  if (!navigator.geolocation) {
    alert("Seu navegador não suporta geolocalização!");
    return;
  }

  let latitude, longitude;

  // tenta por até 10 segundos
  const posicao = await new Promise((resolve, reject) => {
    const timeout = setTimeout(() => reject("Tempo limite excedido!"), 10000);
    navigator.geolocation.getCurrentPosition(
      pos => {
        clearTimeout(timeout);
        resolve(pos);
      },
      err => {
        clearTimeout(timeout);
        reject("Não foi possível obter localização. Ative o GPS e tente novamente.");
      },
      { enableHighAccuracy: true }
    );
  }).catch(erro => {
    alert(erro);
    return null;
  });

  if (!posicao) return; // interrompe se não tiver localização

  latitude = posicao.coords.latitude;
  longitude = posicao.coords.longitude;

  const horario = new Date().toLocaleTimeString();

  // gera ou recupera um ID único para o dispositivo
  let deviceId = localStorage.getItem("deviceId");
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem("deviceId", deviceId);
  }

  const res = await fetch(`${baseURL}/presenca`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nome, matricula, latitude, longitude, horario, deviceId })
  });

  const data = await res.json();
  const saida = document.getElementById("saida");
  saida.innerText = data.msg;

  // mostra imagem de confirmação apenas se o envio for sucesso
  if (data.msg.includes("registrado com sucesso")) {
    const confirmacao = document.getElementById("confirmacao");
    const mensagem = document.getElementById("mensagem-confirmacao");

    mensagem.textContent = `Presença anotada às ${horario} de ${nome}.`;
    confirmacao.style.display = "block";

    // efeito suave
    confirmacao.style.opacity = "1";
    setTimeout(() => {
      confirmacao.style.transition = "opacity 1s";
      confirmacao.style.opacity = "0";
      setTimeout(() => (confirmacao.style.display = "none"), 1000);
    }, 5000);
  }
}
</script>